---
title: "___"
author: "___"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

... Introduction et but...

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

...Matériel et méthodes...

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts")
library(zoo)
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->

```{r}
# Importation 
mobility  <- read("data/mobility_wallonia.rds")

```

```{r}
# Remomer les colonnes
mobil <- mobility %>%
  rename(
    retail = retail_and_recreation_percent_change_from_baseline,
    grocery = grocery_and_pharmacy_percent_change_from_baseline,
    parks = parks_percent_change_from_baseline,
    transir = transit_stations_percent_change_from_baseline,
    workplaces = workplaces_percent_change_from_baseline,
    residential = residential_percent_change_from_baseline)
```

```{r}
#Création de mobil sans les Week-ends 

# Copie du data.frame source
mobil_nwe <- mobil

# S'assurer que la colonne date est de type Date
mobil_nwe$date <- as.Date(mobil_nwe$date)

# Jour de la semaine (1 = lundi, ..., 7 = dimanche)
mobil_nwe$wday <- as.integer(format(mobil_nwe$date, "%u"))

# Colonnes numériques à nettoyer
numeric_cols <- names(mobil_nwe)[vapply(mobil_nwe, is.numeric, logical(1))]
numeric_cols <- setdiff(numeric_cols, "wday")
numeric_cols <- setdiff(numeric_cols, "date")

# Remplacement des valeurs des week-ends par NA
mobil_nwe[mobil_nwe$wday %in% c(6, 7), numeric_cols] <- NA

```

### Richard code

```{r}
# Conversion en ts de mobil
mobil_ts1 <- ts(mobil$workplaces, start = c(2020, 46), frequency = 365)

# c(2020,46), le deuxième nombre correspond au n jour par rapport à la fréquence, Attention 2020 est année bissextile donc 29 jours en juin donc décalage de 1 jour après le 29/02/2020

# Graphique de l'objet ts
plot(mobil_ts1, xlab = "Temps [année]", ylab = "Mobilité vers les lieux de travail (% par rapport à la référence)")
```

Les weekend-ends, la plupart des gens ne travail pas, cela rajoute un fort bruit de fond en augmentant la proportion de gens qui vont travaillés par rapport a la référence, nous les supprimons en les transformant en NA et les collapsons pour unifier la séries.


```{r}
mobil_nwe_ts1 <- ts(mobil_nwe$workplaces,start = c(2020, 46),frequency = 365)

plot(mobil_nwe_ts1, 
     main = "Série journalière (week-ends = NA)", xlab = "Temps [année]",
     ylab = "Mobilité vers les lieux de travail (% par rapport à la référence)")

# Aggrégation par moyenne des valeurs par semaine
mobil_nwe_ts1b <- aggregate(mobil_nwe_ts1, 52, FUN = collapse::fmean, ts.eps = 1/52)

plot(mobil_nwe_ts1b, 
     main = "Série journalière aggrégée (week-ends = NA)", xlab = "Temps [année]",
     ylab = "Mobilité vers les lieux de travail (% par rapport à la référence)")
```

Pour validée notre choix nous visualisions la séries original et la série modifier superposées.


```{r}
# Premier graphique : série originale
plot(mobil_ts1, 
     xlab = "Temps [année]", 
     ylab = "Mobilité vers les lieux de travail (% par rapport à la référence)", 
     main = "Superposition de séries", col = rgb(0, 0, 0, alpha = 0.1))

# Ajouter la deuxième série : week-ends supprimés
lines(mobil_nwe_ts1b, col = "red")

# Optionnel : ajouter une légende
legend("topright", 
       legend = c("Série originale", "Série journalière aggrégée (week-ends = NA)"), 
       col = c("black", "red"), 
       lty = 1)
```




```{r}
mobil_sl1 <- stat.slide(time(mobil_nwe_ts1b), mobil_nwe_ts1b, xmin = 2020, deltat = 0.2)
# Graphique des statistiques glissantes
plot(mobil_sl1, xlab = "Temps [année]", ylab = "Mobilité vers les lieux de travail (% par rapport à la référence)")
legend(2020.2, 5, c("serie","médian"), col = 1:2, lty = 1)

```



```{r}
acf <- acf(mobil_nwe_ts1b)
```


```{r}
loc <- local.trend(mobil_nwe_ts1b)
```



```{r}
set.seed(20010309)
mobil_trend1 <- trend.test(mobil_nwe_ts1b, R= 1000)
plot(mobil_trend1)
```

f

```{r}
# !!!! Besoins de correction
# Analyse spectrale
Mspec <- spectrum(mobil_nwe_ts1b, spans = c(3, 5))

# Périodogramme cumulatif
cpgram(mobil_nwe_ts1b)
```

```{r}
(mobil_stat1.cycle <- cycle(mobil_nwe_ts1b))
boxplot(split(mobil_nwe_ts1b, mobil_stat1.cycle), col = "cornsilk")
```

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
